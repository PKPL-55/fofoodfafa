{% extends 'base.html' %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <title>Register</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body class="bg-gray-200">
<div class="flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-lg shadow-lg p-8 w-96">
        <h2 class="text-2xl font-semibold text-center mb-6">Registrasi</h2>
        <form method="post" novalidate>
            {% csrf_token %}
            <!-- Pilihan Role -->
            <div class="form-group mb-6">
                <label for="role" class="block text-sm font-medium text-gray-700">Pilih Role</label>
                <select class="form-control mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" id="role" name="role">
                    <option value="admin">Admin</option>
                    <option value="buyer">Buyer</option>
                </select>
                {% if form.role.errors %}
                    <div class="text-red-500 text-sm mt-1">
                        {{ form.role.errors|join:", " }}
                    </div>
                {% endif %}
            </div>
            <!-- Field User General -->
            <div class="form-group mb-6">
                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                <input type="text" class="form-control mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" id="username" name="username" value="{{ form.username.value|default_if_none:'' }}" required>
                {% if form.username.errors %}
                    <div class="text-red-500 text-sm mt-1">
                        {{ form.username.errors|join:", " }}
                    </div>
                {% endif %}
            </div>
            <div class="form-group mb-6">
                <label for="full_name" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                <input type="text" class="form-control mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" id="full_name" name="full_name" value="{{ form.full_name.value|default_if_none:'' }}" required>
                {% if form.full_name.errors %}
                    <div class="text-red-500 text-sm mt-1">
                        {{ form.full_name.errors|join:", " }}
                    </div>
                {% endif %}
            </div>
            <div class="form-group mb-6">
                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" class="form-control mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" id="email" name="email" value="{{ form.email.value|default_if_none:'' }}" required>
                {% if form.email.errors %}
                    <div class="text-red-500 text-sm mt-1">
                        {{ form.email.errors|join:", " }}
                    </div>
                {% endif %}
            </div>
            <div class="form-group mb-6">
                <label for="password1" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" class="form-control mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" id="password1" name="password1" required>
                {% if form.password1.errors %}
                    <div class="text-red-500 text-sm mt-1">
                        {{ form.password1.errors|join:", " }}
                    </div>
                {% endif %}
            </div>
            <div class="form-group mb-6">
                <label for="password2" class="block text-sm font-medium text-gray-700">Konfirmasi Password</label>
                <input type="password" class="form-control mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" id="password2" name="password2" required>
                {% if form.password2.errors %}
                    <div class="text-red-500 text-sm mt-1">
                        {{ form.password2.errors|join:", " }}
                    </div>
                {% endif %}
            </div>
            <!-- Field Khusus Buyer -->
            <div id="buyer_fields" style="display: none;">
                <div class="form-group mb-6">
                    <label for="alamat" class="block text-sm font-medium text-gray-700">Alamat</label>
                    <input type="text" class="form-control mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" id="alamat" name="alamat" value="{{ form.alamat.value|default_if_none:'' }}">
                    {% if form.alamat.errors %}
                        <div class="text-red-500 text-sm mt-1">
                            {{ form.alamat.errors|join:", " }}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group mb-6">
                    <label for="no_hp" class="block text-sm font-medium text-gray-700">Nomor HP</label>
                    <input type="text" class="form-control mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" id="no_hp" name="no_hp" value="{{ form.no_hp.value|default_if_none:'' }}">
                    {% if form.no_hp.errors %}
                        <div class="text-red-500 text-sm mt-1">
                            {{ form.no_hp.errors|join:", " }}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group mb-6">
                    <label for="jenis_kelamin" class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                    <select class="form-control mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" id="jenis_kelamin" name="jenis_kelamin">
                        <option value="L" {% if form.jenis_kelamin.value == "L" %}selected{% endif %}>Laki-laki</option>
                        <option value="P" {% if form.jenis_kelamin.value == "P" %}selected{% endif %}>Perempuan</option>
                    </select>
                    {% if form.jenis_kelamin.errors %}
                        <div class="text-red-500 text-sm mt-1">
                            {{ form.jenis_kelamin.errors|join:", " }}
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Field CAPTCHA -->
            <div class="form-group mb-6">
                <label for="id_captcha_1" class="block text-sm font-medium text-gray-700">Captcha</label>
                <div class="flex items-center mt-1">
                    <!-- Bungkus widget captcha ke dalam container agar dapat memperbarui gambar saja -->
                    <div id="captcha_container">
                        {{ form.captcha }}
                    </div>
                    <button type="button" id="refresh_captcha" class="ml-4 bg-gray-600 text-white px-3 py-1 rounded">
                        Refresh
                    </button>
                </div>
                {% if form.captcha.errors %}
                    <div class="text-red-500 text-sm mt-1">
                        {{ form.captcha.errors|join:", " }}
                    </div>
                {% endif %}
            </div>
            <p class="mt-3 text-center py-6">Sudah punya akun? <a href="{% url 'authentication:login' %}" class="text-blue-500 hover:underline">Login</a></p>
            <button type="submit" class="w-full bg-gray-800 text-white py-2 rounded hover:bg-gray-700 transition">Register</button>
        </form>
    </div>
</div>
<script>
    $(document).ready(function(){
        // Tampilkan atau sembunyikan field buyer sesuai pilihan role
        $('#role').change(function(){
            var role = $(this).val();
            if(role === 'buyer'){
                $('#buyer_fields').slideDown();
                $('#alamat, #no_hp, #jenis_kelamin').attr('required', true);
            } else {
                $('#buyer_fields').slideUp();
                $('#alamat, #no_hp, #jenis_kelamin').removeAttr('required');
            }
        });
        $('#role').trigger('change');

        // Fungsi refresh captcha melalui AJAX
        $('#refresh_captcha').click(function(){
            $.getJSON("{% url 'authentication:refresh_captcha' %}", function(data) {
                var new_key = data.key;
                var new_image_url = data.image_url;
                // Update nilai hidden captcha (input dengan id "id_captcha_0")
                $('#id_captcha_0').val(new_key);
                // Perbarui src dari gambar captcha yang ada di dalam container
                $('#captcha_container img').attr('src', new_image_url);
            });
            return false;
        });
    });
</script>
</body>
{% endblock content %}
